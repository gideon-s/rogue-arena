// Generated by CoffeeScript 1.7.1
(function() {
  window.Game = (function() {
    Game.init = function() {
      return this.game = new Game();
    };

    function Game() {
      var height, width;
      height = 60;
      width = 140;
      this.map = new Map(this, width, height);
      this.actors = [];
      this.display = new ROT.Display({
        width: width,
        height: height,
        spacing: 1.1,
        fontSize: 12
      });
      document.body.appendChild(this.display.getContainer());
      this.drawWholeMap();
      this.player = new Player(this, this.map.randomLocation());
      this.spawn();
      this.drawScore();
    }

    Game.prototype.drawWholeMap = function() {
      return _.each(this.map.locations(), (function(_this) {
        return function(location) {
          return _this.drawMapLocation(location);
        };
      })(this));
    };

    Game.prototype.drawMapLocation = function(location) {
      return this.draw(location, this.map.at(location));
    };

    Game.prototype.draw = function(location, character, color) {
      return location.drawOn(this.display, character, color);
    };

    Game.prototype.drawScore = function() {
      return this.display.drawText(height / 2, 0, "Score: " + this.player.score);
    };

    Game.prototype.enters = function(entity) {
      return _.each(entity.location.otherActors(entity), (function(_this) {
        return function(actor) {
          return actor.struckBy(entity);
        };
      })(this));
    };

    Game.prototype.died = function(entity) {
      this.actors = _.without(this.actors, entity);
      return entity.died();
    };

    Game.prototype.spawn = function() {
      var type;
      if (Util.oneIn(2)) {
        type = MinorDemon;
      } else {
        type = Gridbug;
      }
      this.actors.push(new type(this, this.map.randomEdgeLocation()));
      return window.setTimeout(((function(_this) {
        return function() {
          return _this.spawn();
        };
      })(this)), 1000);
    };

    Game.prototype.gameOver = function() {
      this.display.drawText(5, 5, "You have died.  Game Over. Score: " + this.player.score + " Press [ESC] to restart");
      return window.addEventListener("keydown", this);
    };

    Game.prototype.handleEvent = function(e) {
      var code;
      code = e.keyCode;
      if (code === 27) {
        location.reload();
      }
    };

    Game.prototype.nextAction = function(action, speed) {
      return window.setTimeout((function() {
        return action();
      }), speed);
    };

    return Game;

  })();

}).call(this);
